// schema.prisma
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters", "fullTextSearch", "fullTextIndex"]
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum MetricType {
  DEPTH
  WATER_TEMPERATURE
  DECO_STOP
  DIVE_TIME
  ASCENT_RATE
  SURFACE_INTERVAL
  GAS_MIX
  HEART_RATE
  HEART_RATE_VARIABILITY
  SPO2
  BLOOD_PRESSURE_SYSTOLIC
  BLOOD_PRESSURE_DIASTOLIC
  BLOOD_GLUCOSE
  KETONES
  LACTATE
  POWER_OUTPUT
  CADENCE
  SPEED
  ALTITUDE
}

enum DataSource {
  INBODY_970
  INBODY_770
  INBODY_270
  BIA_MULTIFRECUENCIA
  BIA_SEGMENTAL
  BIA_HANDHELD
  GARMIN_FENIX_7
  GARMIN_FENIX_7X
  GARMIN_DESCENT_MK2
  GARMIN_DESCENT_MK3
  GARMIN_SCALE
  APPLE_WATCH_ULTRA
  APPLE_WATCH_S9
  WHOOP_4
  OURA_RING_3
  SHEARWATER_PERDIX
  SHEARWATER_PETREL
  SHEARWATER_TERIC
  SUUNTO_D5
  SUUNTO_EON_CORE
  MANUAL_ENTRY
  IMPORT_CSV
  API_INTEGRATION
  LAB_ANALYSIS
  WITHINGS_B2B
  WITHINGS_API
}

enum ActivityLevel {
  SEDENTARY
  LIGHTLY_ACTIVE
  MODERATELY_ACTIVE
  VERY_ACTIVE
  EXTREMELY_ACTIVE
}

enum EventSeverity {
  CRITICAL
  WARNING
  INFO
  DEBUG
}

enum EventType {
  DECO_VIOLATION
  ASCENT_RATE_EXCEEDED
  LOW_GAS_ALARM
  DIVE_EMERGENCY
  HEART_RATE_ANOMALY
  HRV_LOW
  SPO2_CRITICAL
  TEMPERATURE_ANOMALY
  SIGNIFICANT_WEIGHT_CHANGE
  MUSCLE_GAIN_DETECTED
  MUSCLE_LOSS_DETECTED
  BODY_FAT_THRESHOLD
  DATA_CONFLICT
  SYNC_COMPLETED
  NEW_DATA_AVAILABLE
  CHAT_SESSION_STARTED
}

enum ChatMessageRole {
  USER
  ASSISTANT
  SYSTEM
  EVENT
}

enum DocumentType {
  NUTRITION
  WORKOUT
  PRESCRIPTION
  LAB_RESULT
  OTHER
}

// ============================================================================
// MODELOS PRINCIPALES
// ============================================================================

model Patient {
  id                String   @id @default(cuid())
  name              String
  email             String   @unique
  age               Int?
  height            Float?
  targetWeight      Float?
  activityLevel     ActivityLevel @default(MODERATELY_ACTIVE)
  lastChatAt        DateTime?
  lastProcessedAt   DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Withings
  withingsUserId    String?   @unique
  withingsToken     String?
  withingsRefresh   String?
  withingsExpires   DateTime?
  
  // Relaciones
  compositions      CompositionRecord[]
  biometrics        BiometricSnapshot[]
  labResults        LabResult[]
  prescriptions     Prescription[]
  metrics           MetricLog[]
  chatSessions      ChatSession[]
  systemEvents      SystemEvent[]
  protocolDocuments ProtocolDocument[]
  documentAccessLogs DocumentAccessLog[]
  advisorSessions   AdvisorSession[]
  
  @@index([email])
  @@index([lastChatAt])
}

model CompositionRecord {
  id              String     @id @default(cuid())
  patientId       String
  date            DateTime   @default(now())
  weight          Float
  smm             Float
  pbf             Float
  bodyFatMass     Float
  totalBodyWater  Float
  protein         Float
  minerals        Float
  bmr             Int
  vfl             Int
  phaseAngle      Float
  waistHipRatio   Float?
  rightArmMuscle  Float?
  leftArmMuscle   Float?
  trunkMuscle     Float?
  rightLegMuscle  Float?
  leftLegMuscle   Float?
  source          DataSource @default(INBODY_270)
  deviceId        String?
  isLatest        Boolean    @default(false)
  notes           String?
  
  patient         Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId, isLatest])
  @@index([patientId, date(sort: Desc)])
}

model BiometricSnapshot {
  id            String     @id @default(cuid())
  patientId     String
  bpm           Int?
  hrv           Float?
  hrvStatus     String?
  spo2          Float?
  bloodPressureSystolic   Int?
  bloodPressureDiastolic  Int?
  temperature   Float?
  skinTemp      Float?
  steps         Int?
  calories      Int?
  activeMinutes Int?
  sleepScore    Int?
  recoveryScore Int?
  stressLevel   Int?
  recordedAt    DateTime   @default(now())
  source        DataSource
  deviceId      String?
  isSynced      Boolean    @default(false)
  
  patient       Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId, recordedAt(sort: Desc)])
}

model MetricLog {
  id          String     @id @default(cuid())
  patientId   String
  type        MetricType
  value       Float
  unit        String
  startedAt   DateTime   @default(now())
  endedAt     DateTime?
  duration    Int?
  metadata    Json?
  location    Json?
  source      DataSource
  deviceId    String?
  isProcessed Boolean    @default(false)
  hasAlert    Boolean    @default(false)
  
  patient     Patient    @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId, type, startedAt(sort: Desc)])
}

model LabResult {
  id            String   @id @default(cuid())
  patientId     String
  name          String
  category      String
  value         Float
  unit          String
  referenceMin  Float?
  referenceMax  Float?
  status        String
  flagged       Boolean  @default(false)
  date          DateTime @default(now())
  labName       String?
  notes         String?
  
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId, date(sort: Desc)])
}

model Prescription {
  id            String   @id @default(cuid())
  patientId     String
  medication    String
  dosage        String
  frequency     String
  prescribedBy  String
  prescribedAt  DateTime @default(now())
  validUntil    DateTime?
  notes         String?
  isActive      Boolean  @default(true)
  documentUrl   String?
  
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId, isActive])
}

// ============================================================================
// CHAT & EVENTS
// ============================================================================

model ChatSession {
  id          String   @id @default(cuid())
  patientId   String
  startedAt   DateTime @default(now())
  endedAt     DateTime?
  context     Json?
  
  messages    ChatMessage[]
  
  patient     Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId, startedAt(sort: Desc)])
}

model ChatMessage {
  id          String          @id @default(cuid())
  sessionId   String
  role        ChatMessageRole
  content     String          @db.Text
  tokensUsed  Int?
  model       String?
  latencyMs   Int?
  telemetryContext  Json?
  patientDataContext Json?
  triggeredEvents   String[]
  createdAt   DateTime        @default(now())
  
  session     ChatSession     @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId, createdAt])
}

model SystemEvent {
  id          String       @id @default(cuid())
  patientId   String
  type        EventType
  severity    EventSeverity
  title       String
  description String       @db.Text
  data        Json?
  isRead      Boolean      @default(false)
  isProcessed Boolean      @default(false)
  acknowledgedAt DateTime?
  relatedMetrics String[]
  relatedCompositions String[]
  createdAt   DateTime     @default(now())
  expiresAt   DateTime?
  
  patient     Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId, createdAt(sort: Desc)])
  @@index([type, isProcessed])
}

// ============================================================================
// ARKANGEL ADVISOR (Dr. Chat)
// ============================================================================

model AdvisorSession {
  id            String   @id @default(cuid())
  patientId     String
  arkangelConvId String?
  phaseAngleAtStart Float?
  latestCompositionId String?
  startedAt     DateTime @default(now())
  endedAt       DateTime?
  category      String?
  actionsTaken  String[]
  
  messages      AdvisorMessage[]
  
  patient       Patient  @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([patientId, startedAt(sort: Desc)])
  @@index([arkangelConvId])
}

model AdvisorMessage {
  id            String   @id @default(cuid())
  sessionId     String
  arkangelMsgId String?
  role          String
  content       String   @db.Text
  sources       Json?
  tokensUsed    Int?
  createdAt     DateTime @default(now())
  
  session       AdvisorSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  
  @@index([sessionId, createdAt])
}

// ============================================================================
// DOCUMENTS
// ============================================================================

model ProtocolDocument {
  id            String       @id @default(cuid())
  patientId     String
  type          DocumentType
  title         String
  description   String?
  fileUrl       String
  fileSize      String?
  checksum      String?
  version       String       @default("1.0")
  isLatest      Boolean      @default(true)
  prescribedBy  String?
  validUntil    DateTime?
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  lastAccessed  DateTime?
  
  patient       Patient      @relation(fields: [patientId], references: [id], onDelete: Cascade)
  accessLogs    DocumentAccessLog[]
  
  @@index([patientId, type, isLatest])
}

model DocumentAccessLog {
  id          String   @id @default(cuid())
  documentId  String
  patientId   String
  accessedAt  DateTime @default(now())
  ipAddress   String?
  userAgent   String?
  
  document    ProtocolDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  patient     Patient @relation(fields: [patientId], references: [id], onDelete: Cascade)
  
  @@index([documentId, accessedAt])
}

// ============================================================================
// CONFIG
// ============================================================================

model PatientConfig {
  id              String   @id @default(cuid())
  patientId       String   @unique
  alertOnDecoViolation Boolean @default(true)
  alertOnDataConflict  Boolean @default(true)
  alertThresholdBPM    Int?
  preferredUnitWeight  String  @default("kg")
  preferredUnitHeight  String  @default("cm")
  targetSMM           Float?
  targetPBF           Float?
  maxDepthAlert       Float?
  updatedAt           DateTime @updatedAt
}